---
/**
 * VideoEmbed.astro
 * YouTube/Vimeo embed with offline fallback
 */

interface Props {
  src: string;
  title: string;
  fallbackImage?: string;
  autoplay?: boolean;
  muted?: boolean;
  loop?: boolean;
  aspectRatio?: string;
}

const {
  src,
  title,
  fallbackImage,
  autoplay = false,
  muted = false,
  loop = false,
  aspectRatio = '16 / 9'
} = Astro.props;

// Parse video source to determine type
function parseVideoSrc(url: string): { type: 'youtube' | 'vimeo' | 'local'; id?: string; embedUrl?: string } {
  // YouTube patterns
  const youtubeMatch = url.match(/(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
  if (youtubeMatch) {
    const params = new URLSearchParams();
    if (autoplay) params.set('autoplay', '1');
    if (muted) params.set('mute', '1');
    if (loop) {
      params.set('loop', '1');
      params.set('playlist', youtubeMatch[1]);
    }
    params.set('rel', '0');
    params.set('modestbranding', '1');

    return {
      type: 'youtube',
      id: youtubeMatch[1],
      embedUrl: `https://www.youtube-nocookie.com/embed/${youtubeMatch[1]}?${params.toString()}`
    };
  }

  // Vimeo patterns
  const vimeoMatch = url.match(/(?:vimeo\.com\/|player\.vimeo\.com\/video\/)(\d+)/);
  if (vimeoMatch) {
    const params = new URLSearchParams();
    if (autoplay) params.set('autoplay', '1');
    if (muted) params.set('muted', '1');
    if (loop) params.set('loop', '1');

    return {
      type: 'vimeo',
      id: vimeoMatch[1],
      embedUrl: `https://player.vimeo.com/video/${vimeoMatch[1]}?${params.toString()}`
    };
  }

  // Local video
  return { type: 'local' };
}

const video = parseVideoSrc(src);

// Generate YouTube thumbnail URL if no fallback provided
const thumbnail = fallbackImage
  ? fallbackImage
  : video.type === 'youtube'
    ? `https://img.youtube.com/vi/${video.id}/maxresdefault.jpg`
    : undefined;
---

<div class="video-embed" data-video-embed style={`aspect-ratio: ${aspectRatio}`}>
  {video.type === 'local' ? (
    <!-- Local video -->
    <video
      class="video-embed__video"
      controls
      preload="metadata"
      autoplay={autoplay}
      muted={muted}
      loop={loop}
      poster={fallbackImage}
    >
      <source src={src} type={`video/${src.split('.').pop()}`} />
      <p>Your browser does not support the video tag.</p>
    </video>
  ) : (
    <!-- External embed with lazy loading -->
    <div class="video-embed__wrapper" data-video-wrapper>
      <!-- Fallback/Thumbnail -->
      <div class="video-embed__fallback" data-video-fallback>
        {thumbnail && (
          <img
            src={thumbnail}
            alt={`${title} thumbnail`}
            loading="lazy"
            decoding="async"
            class="video-embed__thumbnail"
          />
        )}

        <button
          class="video-embed__play-btn"
          type="button"
          aria-label={`Play ${title}`}
          data-video-play
          data-embed-url={video.embedUrl}
        >
          <svg width="64" height="64" viewBox="0 0 64 64" fill="none">
            <circle cx="32" cy="32" r="30" fill="rgba(0,0,0,0.7)" stroke="white" stroke-width="2"/>
            <path d="M26 20v24l20-12-20-12z" fill="white"/>
          </svg>
        </button>

        <span class="video-embed__offline-notice">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path d="M1 8a7 7 0 0114 0M4 11a4 4 0 018 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <circle cx="8" cy="14" r="1" fill="currentColor"/>
          </svg>
          Requires internet connection
        </span>
      </div>

      <!-- Iframe container (loaded on click) -->
      <div class="video-embed__iframe-container" data-iframe-container hidden></div>
    </div>
  )}

  <div class="video-embed__caption">
    <span class="video-embed__title">{title}</span>
    {video.type !== 'local' && (
      <a
        href={src}
        target="_blank"
        rel="noopener noreferrer"
        class="video-embed__external"
      >
        Watch on {video.type === 'youtube' ? 'YouTube' : 'Vimeo'}
        <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
          <path d="M10.5 1.5L1.5 10.5M10.5 1.5H4.5M10.5 1.5V7.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </a>
    )}
  </div>
</div>

<style>
  .video-embed {
    width: 100%;
    background-color: var(--color-surface-alt);
    border-radius: var(--radius-lg);
    overflow: hidden;
    margin: var(--space-4) 0;
  }

  .video-embed__video {
    width: 100%;
    height: 100%;
    display: block;
  }

  .video-embed__wrapper {
    position: relative;
    width: 100%;
    height: 100%;
  }

  .video-embed__fallback {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background-color: var(--color-background);
  }

  .video-embed__thumbnail {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .video-embed__play-btn {
    position: relative;
    z-index: 1;
    background: none;
    border: none;
    cursor: pointer;
    transition: transform var(--transition-fast);
  }

  .video-embed__play-btn:hover {
    transform: scale(1.1);
  }

  .video-embed__play-btn:focus-visible {
    outline: 2px solid white;
    outline-offset: 4px;
    border-radius: 50%;
  }

  .video-embed__offline-notice {
    position: absolute;
    bottom: var(--space-4);
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-3);
    background-color: rgba(0, 0, 0, 0.7);
    border-radius: var(--radius-full);
    color: white;
    font-size: var(--font-size-xs);
  }

  .video-embed__iframe-container {
    position: absolute;
    inset: 0;
  }

  .video-embed__iframe-container[hidden] {
    display: none;
  }

  .video-embed__iframe-container iframe {
    width: 100%;
    height: 100%;
    border: none;
  }

  .video-embed__caption {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-3) var(--space-4);
    background-color: var(--color-surface-alt);
    border-top: 1px solid var(--color-border);
  }

  .video-embed__title {
    font-size: var(--font-size-sm);
    font-weight: 500;
    color: var(--color-text);
  }

  .video-embed__external {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
  }

  .video-embed__external:hover {
    color: var(--color-primary);
  }
</style>

<script>
  // Lazy load iframe on play button click
  document.querySelectorAll('[data-video-play]').forEach(button => {
    button.addEventListener('click', () => {
      const wrapper = button.closest('[data-video-wrapper]');
      const fallback = wrapper?.querySelector('[data-video-fallback]');
      const container = wrapper?.querySelector('[data-iframe-container]');
      const embedUrl = button.getAttribute('data-embed-url');

      if (container && embedUrl) {
        // Create and insert iframe
        const iframe = document.createElement('iframe');
        iframe.src = embedUrl;
        iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
        iframe.allowFullscreen = true;
        iframe.title = button.getAttribute('aria-label') || 'Video';

        container.appendChild(iframe);
        container.hidden = false;

        // Hide fallback
        if (fallback) {
          (fallback as HTMLElement).style.display = 'none';
        }
      }
    });
  });
</script>
