---
/**
 * Tabs.astro
 * Tabbed content component with accessible keyboard navigation
 * Uses CSS-only approach with single slot for content
 */

interface Tab {
  id: string;
  label: string;
  icon?: string;
}

interface Props {
  tabs: Tab[];
  defaultTab?: string;
}

const { tabs, defaultTab } = Astro.props;

const activeTab = defaultTab || tabs[0]?.id;
const tabsId = `tabs-${Math.random().toString(36).slice(2, 9)}`;
---

<div class="tabs" data-tabs id={tabsId}>
  <div class="tabs__list" role="tablist" aria-label="Content tabs">
    {tabs.map((tab, index) => (
      <button
        type="button"
        role="tab"
        class="tabs__tab"
        id={`${tabsId}-tab-${tab.id}`}
        aria-controls={`${tabsId}-panel-${tab.id}`}
        aria-selected={tab.id === activeTab ? 'true' : 'false'}
        tabindex={tab.id === activeTab ? 0 : -1}
        data-tab={tab.id}
      >
        {tab.icon && <span class="tabs__icon" set:html={tab.icon} />}
        <span class="tabs__label">{tab.label}</span>
      </button>
    ))}
  </div>

  <div class="tabs__panels">
    <slot />
  </div>
</div>

<style>
  .tabs {
    width: 100%;
  }

  .tabs__list {
    display: flex;
    gap: var(--space-1);
    border-bottom: 1px solid var(--color-border);
    margin-bottom: var(--space-4);
    overflow-x: auto;
    scrollbar-width: none;
    -ms-overflow-style: none;
  }

  .tabs__list::-webkit-scrollbar {
    display: none;
  }

  .tabs__tab {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-4);
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    color: var(--color-text-muted);
    font-size: var(--font-size-sm);
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-fast);
    white-space: nowrap;
    margin-bottom: -1px;
  }

  .tabs__tab:hover {
    color: var(--color-text);
    background-color: var(--color-surface-alt);
  }

  .tabs__tab[aria-selected="true"] {
    color: var(--color-primary);
    border-bottom-color: var(--color-primary);
  }

  .tabs__tab:focus-visible {
    outline: 2px solid var(--color-primary);
    outline-offset: -2px;
  }

  .tabs__icon {
    display: flex;
    align-items: center;
    color: inherit;
  }

  .tabs__icon :global(svg) {
    width: 16px;
    height: 16px;
  }

  .tabs__panels {
    min-height: 100px;
  }

  /* Tab panel styling - expect content to be wrapped in data-tab-panel elements */
  .tabs__panels :global([data-tab-panel]) {
    outline: none;
    display: none;
  }

  .tabs__panels :global([data-tab-panel].active) {
    display: block;
  }

  .tabs__panels :global([data-tab-panel]:focus-visible) {
    outline: 2px solid var(--color-primary);
    outline-offset: 2px;
    border-radius: var(--radius-sm);
  }

  /* Compact variant */
  .tabs--compact .tabs__tab {
    padding: var(--space-2) var(--space-3);
    font-size: var(--font-size-xs);
  }

  /* Pill variant */
  .tabs--pills .tabs__list {
    border-bottom: none;
    gap: var(--space-2);
    margin-bottom: var(--space-4);
  }

  .tabs--pills .tabs__tab {
    border-radius: var(--radius-full);
    border-bottom: none;
    background-color: var(--color-surface-alt);
  }

  .tabs--pills .tabs__tab[aria-selected="true"] {
    background-color: var(--color-primary);
    color: white;
  }

  /* Responsive */
  @media (max-width: 640px) {
    .tabs__list {
      gap: 0;
    }

    .tabs__tab {
      flex: 1;
      justify-content: center;
      padding: var(--space-2);
    }

    .tabs__label {
      display: none;
    }

    .tabs__icon {
      margin: 0;
    }

    .tabs__icon + .tabs__label {
      display: block;
    }
  }
</style>

<script>
  document.querySelectorAll('[data-tabs]').forEach(tabsContainer => {
    const tabList = tabsContainer.querySelector('[role="tablist"]');
    const tabs = tabsContainer.querySelectorAll('[role="tab"]');
    const panels = tabsContainer.querySelectorAll('[data-tab-panel]');

    // Set initial active state based on which tab is selected
    const initialTab = tabsContainer.querySelector('[aria-selected="true"]');
    if (initialTab) {
      const initialTabId = initialTab.getAttribute('data-tab');
      panels.forEach(panel => {
        if (panel.getAttribute('data-tab-panel') === initialTabId) {
          panel.classList.add('active');
        } else {
          panel.classList.remove('active');
        }
      });
    } else if (panels.length > 0) {
      // Default to first panel
      panels[0].classList.add('active');
    }

    function switchTab(newTab: HTMLElement) {
      const targetId = newTab.getAttribute('data-tab');

      // Update tabs
      tabs.forEach(tab => {
        const isSelected = tab === newTab;
        tab.setAttribute('aria-selected', String(isSelected));
        tab.setAttribute('tabindex', isSelected ? '0' : '-1');
      });

      // Update panels
      panels.forEach(panel => {
        const isSelected = panel.getAttribute('data-tab-panel') === targetId;
        if (isSelected) {
          panel.classList.add('active');
        } else {
          panel.classList.remove('active');
        }
      });

      // Focus the new tab
      newTab.focus();
    }

    // Click handler
    tabs.forEach(tab => {
      tab.addEventListener('click', () => switchTab(tab as HTMLElement));
    });

    // Keyboard navigation
    tabList?.addEventListener('keydown', (e: Event) => {
      const event = e as KeyboardEvent;
      const currentTab = document.activeElement as HTMLElement;
      const tabsArray = Array.from(tabs) as HTMLElement[];
      const currentIndex = tabsArray.indexOf(currentTab);

      let newIndex: number | null = null;

      switch (event.key) {
        case 'ArrowLeft':
          newIndex = currentIndex > 0 ? currentIndex - 1 : tabsArray.length - 1;
          break;
        case 'ArrowRight':
          newIndex = currentIndex < tabsArray.length - 1 ? currentIndex + 1 : 0;
          break;
        case 'Home':
          newIndex = 0;
          break;
        case 'End':
          newIndex = tabsArray.length - 1;
          break;
      }

      if (newIndex !== null) {
        event.preventDefault();
        switchTab(tabsArray[newIndex]);
      }
    });
  });
</script>
