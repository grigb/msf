---
/**
 * Sidebar.astro
 * Clean section navigation with navy blue accent active states
 */

interface SidebarItem {
  label: string;
  href: string;
  items?: SidebarItem[];
}

interface SidebarSection {
  title: string;
  items: SidebarItem[];
}

interface Props {
  sections: SidebarSection[];
  currentPath?: string;
}

const { sections, currentPath = '' } = Astro.props;

function isActive(href: string): boolean {
  return currentPath === href || currentPath.startsWith(href + '/');
}

function hasActiveChild(items: SidebarItem[]): boolean {
  return items.some(item =>
    isActive(item.href) || (item.items && hasActiveChild(item.items))
  );
}
---

<aside class="sidebar" data-sidebar>
  <button
    class="sidebar__toggle"
    type="button"
    aria-label="Toggle sidebar"
    data-sidebar-toggle
  >
    <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
      <path d="M4 7l6 6 6-6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
    </svg>
  </button>

  <nav class="sidebar__nav" aria-label="Section navigation">
    {sections.map(section => (
      <div class="sidebar__section">
        <h3 class="sidebar__section-title">{section.title}</h3>
        <ul class="sidebar__list">
          {section.items.map(item => (
            <li class="sidebar__item">
              {item.items && item.items.length > 0 ? (
                <details
                  class="sidebar__details"
                  open={hasActiveChild(item.items) || isActive(item.href)}
                >
                  <summary class="sidebar__summary">
                    <a
                      href={item.href}
                      class:list={['sidebar__link', { 'sidebar__link--active': isActive(item.href) }]}
                      aria-current={isActive(item.href) ? 'page' : undefined}
                    >
                      {item.label}
                    </a>
                    <svg class="sidebar__chevron" width="14" height="14" viewBox="0 0 16 16" fill="none">
                      <path d="M6 4l4 4-4 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                  </summary>
                  <ul class="sidebar__sublist">
                    {item.items.map(subItem => (
                      <li class="sidebar__subitem">
                        <a
                          href={subItem.href}
                          class:list={['sidebar__sublink', { 'sidebar__sublink--active': isActive(subItem.href) }]}
                          aria-current={isActive(subItem.href) ? 'page' : undefined}
                        >
                          {subItem.label}
                        </a>
                      </li>
                    ))}
                  </ul>
                </details>
              ) : (
                <a
                  href={item.href}
                  class:list={['sidebar__link', { 'sidebar__link--active': isActive(item.href) }]}
                  aria-current={isActive(item.href) ? 'page' : undefined}
                >
                  {item.label}
                </a>
              )}
            </li>
          ))}
        </ul>
      </div>
    ))}
  </nav>
</aside>

<style>
  .sidebar {
    width: var(--sidebar-width);
    flex-shrink: 0;
    padding: var(--space-6) var(--space-4);
    border-right: 1px solid var(--color-border);
    background-color: var(--color-surface);
    overflow-y: auto;
    max-height: calc(100vh - var(--header-height));
    position: sticky;
    top: var(--header-height);
  }

  .sidebar__toggle {
    display: none;
    width: 100%;
    padding: var(--space-3);
    background: var(--color-surface-alt);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    cursor: pointer;
    margin-bottom: var(--space-4);
    color: var(--color-text-muted);
  }

  .sidebar__toggle svg {
    transition: transform var(--transition-fast);
  }

  .sidebar[data-collapsed] .sidebar__toggle svg {
    transform: rotate(-90deg);
  }

  .sidebar__nav {
    display: flex;
    flex-direction: column;
    gap: var(--space-6);
  }

  .sidebar[data-collapsed] .sidebar__nav {
    display: none;
  }

  .sidebar__section-title {
    font-size: 10px;
    font-family: var(--font-family-base);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--color-text-light);
    margin-bottom: var(--space-3);
    padding-left: var(--space-3);
  }

  .sidebar__list {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: 1px;
  }

  .sidebar__link {
    display: block;
    padding: var(--space-2) var(--space-3);
    color: var(--color-text-muted);
    font-size: var(--font-size-sm);
    font-weight: 400;
    border-radius: var(--radius-md);
    transition: all var(--transition-fast);
    border: none;
    position: relative;
  }

  .sidebar__link:hover {
    color: var(--color-text-heading);
    background-color: var(--color-surface-alt);
    text-decoration: none;
  }

  .sidebar__link--active {
    color: var(--color-primary);
    background-color: var(--color-primary-light);
    font-weight: var(--font-weight-medium);
  }

  .sidebar__details {
    width: 100%;
  }

  .sidebar__summary {
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    list-style: none;
  }

  .sidebar__summary::-webkit-details-marker {
    display: none;
  }

  .sidebar__summary .sidebar__link {
    flex: 1;
  }

  .sidebar__chevron {
    color: var(--color-text-light);
    transition: transform var(--transition-fast);
    flex-shrink: 0;
    margin-right: var(--space-2);
  }

  .sidebar__details[open] .sidebar__chevron {
    transform: rotate(90deg);
  }

  .sidebar__sublist {
    list-style: none;
    margin-top: var(--space-1);
    margin-left: var(--space-4);
    padding-left: var(--space-3);
    border-left: 1px solid var(--color-border);
  }

  .sidebar__sublink {
    display: block;
    padding: var(--space-2) var(--space-3);
    color: var(--color-text-light);
    font-size: var(--font-size-xs);
    border-radius: var(--radius-md);
    transition: all var(--transition-fast);
    border: none;
  }

  .sidebar__sublink:hover {
    color: var(--color-text);
    background-color: var(--color-surface-alt);
    text-decoration: none;
  }

  .sidebar__sublink--active {
    color: var(--color-primary);
    font-weight: var(--font-weight-medium);
  }

  @media (max-width: 1024px) {
    .sidebar {
      position: fixed;
      left: 0;
      top: var(--header-height);
      bottom: 0;
      z-index: 50;
      transform: translateX(-100%);
      transition: transform var(--transition-smooth);
      box-shadow: var(--shadow-xl);
    }

    .sidebar[data-open] {
      transform: translateX(0);
    }

    .sidebar__toggle {
      display: flex;
      align-items: center;
      justify-content: center;
    }
  }
</style>

<script>
  const sidebar = document.querySelector('[data-sidebar]');
  const toggle = document.querySelector('[data-sidebar-toggle]');

  toggle?.addEventListener('click', () => {
    sidebar?.toggleAttribute('data-collapsed');
  });

  document.addEventListener('click', (e) => {
    if (window.innerWidth <= 1024) {
      const target = e.target as HTMLElement;
      if (!sidebar?.contains(target) && sidebar?.hasAttribute('data-open')) {
        sidebar.removeAttribute('data-open');
      }
    }
  });
</script>
