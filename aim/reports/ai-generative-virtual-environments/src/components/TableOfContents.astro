---
/**
 * TableOfContents.astro
 * Auto-generated table of contents from page headings
 */

interface TocItem {
  depth: number;
  slug: string;
  text: string;
}

interface Props {
  headings?: TocItem[];
  minDepth?: number;
  maxDepth?: number;
  title?: string;
}

const {
  headings = [],
  minDepth = 2,
  maxDepth = 4,
  title = 'On this page'
} = Astro.props;

// Filter headings by depth
const filteredHeadings = headings.filter(
  h => h.depth >= minDepth && h.depth <= maxDepth
);
---

{filteredHeadings.length > 0 && (
  <aside class="toc" data-toc>
    <div class="toc__container">
      <h2 class="toc__title">{title}</h2>
      <nav aria-label="Table of contents">
        <ul class="toc__list">
          {filteredHeadings.map(heading => (
            <li
              class="toc__item"
              style={`--depth: ${heading.depth - minDepth}`}
            >
              <a
                href={`#${heading.slug}`}
                class="toc__link"
                data-toc-link={heading.slug}
              >
                {heading.text}
              </a>
            </li>
          ))}
        </ul>
      </nav>
    </div>
  </aside>
)}

<style>
  .toc {
    width: var(--toc-width);
    flex-shrink: 0;
    padding: var(--space-6);
    position: sticky;
    top: var(--header-height);
    max-height: calc(100vh - var(--header-height));
    overflow-y: auto;
  }

  .toc__container {
    padding-left: var(--space-4);
    border-left: 1px solid var(--color-border);
  }

  .toc__title {
    font-size: var(--font-size-xs);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-muted);
    margin-bottom: var(--space-4);
  }

  .toc__list {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  .toc__item {
    padding-left: calc(var(--depth, 0) * var(--space-4));
  }

  .toc__link {
    display: block;
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
    line-height: var(--line-height-base);
    transition: color var(--transition-fast);
  }

  .toc__link:hover {
    color: var(--color-text);
    text-decoration: none;
  }

  .toc__link--active {
    color: var(--color-primary);
    font-weight: 500;
  }

  @media (max-width: 1280px) {
    .toc {
      display: none;
    }
  }
</style>

<script>
  // Intersection Observer for active heading
  const tocLinks = document.querySelectorAll('[data-toc-link]');
  const headings = document.querySelectorAll('h2[id], h3[id], h4[id]');

  if (tocLinks.length > 0 && headings.length > 0) {
    const observerOptions = {
      rootMargin: '-80px 0px -80% 0px',
      threshold: 0
    };

    let activeId: string | null = null;

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          activeId = entry.target.id;
          updateActiveLink();
        }
      });
    }, observerOptions);

    headings.forEach(heading => observer.observe(heading));

    function updateActiveLink() {
      tocLinks.forEach(link => {
        link.classList.remove('toc__link--active');
        if (link.getAttribute('data-toc-link') === activeId) {
          link.classList.add('toc__link--active');
        }
      });
    }

    // Set initial active state
    if (window.location.hash) {
      activeId = window.location.hash.slice(1);
      updateActiveLink();
    }
  }
</script>
