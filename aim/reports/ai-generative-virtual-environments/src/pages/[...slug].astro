---
/**
 * [...slug].astro
 * Dynamic catch-all route for content pages
 */
import { getCollection, type CollectionEntry } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import Sidebar from '../components/Sidebar.astro';
import TableOfContents from '../components/TableOfContents.astro';
import Breadcrumbs from '../components/Breadcrumbs.astro';
import { navigation } from '../data/navigation';

import MediaPlaceholder from '../components/MediaPlaceholder.astro';
import SRLBadge from '../components/SRLBadge.astro';
import ImplementationCard from '../components/ImplementationCard.astro';
import InfoCard from '../components/InfoCard.astro';
import GapCard from '../components/GapCard.astro';
import ComparisonTable from '../components/ComparisonTable.astro';
import Tabs from '../components/Tabs.astro';
import Accordion from '../components/Accordion.astro';
import VideoEmbed from '../components/VideoEmbed.astro';
import ImageGallery from '../components/ImageGallery.astro';
import ModelViewer from '../components/ModelViewer.astro';
import FilterPanel from '../components/FilterPanel.astro';
import CoverageChart from '../components/CoverageChart.astro';
import PriorityMatrix from '../components/PriorityMatrix.astro';
import SRLChart from '../components/SRLChart.astro';
import ReadinessChart from '../components/ReadinessChart.astro';
import TrajectoryChart from '../components/TrajectoryChart.astro';
import CoordinationDiagram from '../components/CoordinationDiagram.astro';
import SDOCard from '../components/SDOCard.astro';
import SRLScale from '../components/SRLScale.astro';
import KeyFindingCard from '../components/KeyFindingCard.astro';
import ActionItem from '../components/ActionItem.astro';
import TermDefinition from '../components/TermDefinition.astro';

export async function getStaticPaths() {
  const pages = await getCollection('pages');

  return pages.map((page: CollectionEntry<'pages'>) => {
    const slug = page.slug === 'index' ? undefined : page.slug;

    return {
      params: { slug },
      props: { page },
    };
  });
}

type Props = {
  page: CollectionEntry<'pages'>;
};

const { page } = Astro.props;
const { Content, headings } = await page.render();

const { title, description, section, image } = page.data;
const slug = Astro.params.slug || '';

const pathParts = slug ? slug.split('/') : [];
const breadcrumbs = pathParts.map((part, index) => ({
  label: part.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
  href: '/' + pathParts.slice(0, index + 1).join('/') + '/'
}));

const sidebarSections = navigation;
const currentPath = Astro.url.pathname;
---

<BaseLayout title={title} description={description} section={section}>
  <div class="content-page">
    <div class="content-layout">
      <Sidebar sections={sidebarSections} currentPath={currentPath} />

      <div class="content-main">
        <div class="container">
          {breadcrumbs.length > 0 && (
            <Breadcrumbs items={breadcrumbs} />
          )}

          <header class="page-header">
            <h1>{title}</h1>
            {description && <p class="lead">{description}</p>}
          </header>

          {image && section === 'implementations' && (
            <div class="hero-image-banner">
              <img src={image} alt={title} loading="lazy" />
            </div>
          )}

          <div class="content-with-toc">
            <article class="article-content prose">
              <Content
                components={{
                  MediaPlaceholder,
                  SRLBadge,
                  ImplementationCard,
                  InfoCard,
                  GapCard,
                  ComparisonTable,
                  Tabs,
                  Accordion,
                  VideoEmbed,
                  ImageGallery,
                  ModelViewer,
                  FilterPanel,
                  CoverageChart,
                  PriorityMatrix,
                  SRLChart,
                  KeyFindingCard,
                  ActionItem,
                  TermDefinition,
                  ReadinessChart,
                  TrajectoryChart,
                  CoordinationDiagram,
                  SDOCard,
                  SRLScale,
                }}
              />
            </article>

            {headings.length > 0 && (
              <aside class="toc-wrapper">
                <TableOfContents headings={headings} />
              </aside>
            )}
          </div>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<style>
  .content-page {
    min-height: calc(100vh - var(--header-height));
  }

  .content-layout {
    display: flex;
    min-height: calc(100vh - var(--header-height));
  }

  .content-main {
    flex: 1;
    min-width: 0;
    padding: var(--space-8) 0 var(--space-12);
    background-color: var(--color-background);
  }

  .page-header {
    margin-bottom: var(--space-10);
    padding-bottom: var(--space-6);
    border-bottom: 1px solid var(--color-border);
    position: relative;
  }

  .page-header::before {
    content: '';
    position: absolute;
    bottom: -1px;
    left: 0;
    width: 48px;
    height: 2px;
    background: var(--color-primary);
    border-radius: 1px;
  }

  .page-header h1 {
    margin-bottom: var(--space-3);
  }

  .page-header .lead {
    color: var(--color-text-muted);
    font-size: var(--font-size-lg);
    margin-bottom: 0;
    max-width: 60ch;
  }

  .hero-image-banner {
    margin-bottom: var(--space-6);
    border-radius: var(--radius-lg);
    overflow: hidden;
    border: 1px solid var(--color-border);
  }

  .hero-image-banner img {
    width: 100%;
    height: auto;
    aspect-ratio: 16 / 9;
    object-fit: cover;
    display: block;
    margin: 0;
    border: none;
  }

  .content-with-toc {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-8);
  }

  @media (min-width: 1280px) {
    .content-with-toc {
      grid-template-columns: 1fr 200px;
    }
  }

  .article-content {
    min-width: 0;
  }

  /* Prose styles for MDX content */
  .prose :global(h2) {
    margin-top: var(--space-12);
    margin-bottom: var(--space-4);
    padding-top: var(--space-6);
    border-top: 1px solid var(--color-border);
    position: relative;
  }

  .prose :global(h2)::after {
    content: '';
    position: absolute;
    top: -1px;
    left: 0;
    width: 32px;
    height: 2px;
    background: var(--color-primary);
    border-radius: 1px;
  }

  .prose :global(h2:first-child) {
    margin-top: 0;
    padding-top: 0;
    border-top: none;
  }

  .prose :global(h2:first-child)::after {
    display: none;
  }

  .prose :global(h3) {
    margin-top: var(--space-8);
    margin-bottom: var(--space-3);
  }

  .prose :global(h4) {
    margin-top: var(--space-6);
    margin-bottom: var(--space-2);
  }

  .prose :global(p) {
    margin-bottom: var(--space-4);
  }

  .prose :global(ul),
  .prose :global(ol) {
    margin-bottom: var(--space-4);
    padding-left: var(--space-6);
  }

  .prose :global(li) {
    margin-bottom: var(--space-2);
  }

  .prose :global(li::marker) {
    color: var(--color-text-light);
  }

  .prose :global(table) {
    width: 100%;
    margin-bottom: var(--space-6);
    border-collapse: collapse;
    font-size: var(--font-size-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    overflow: hidden;
  }

  .prose :global(th),
  .prose :global(td) {
    padding: var(--space-3) var(--space-4);
    text-align: left;
    border-bottom: 1px solid var(--color-border-light);
  }

  .prose :global(th) {
    font-weight: var(--font-weight-semibold);
    font-family: var(--font-family-base);
    background-color: var(--color-surface-alt);
    color: var(--color-text-muted);
    font-size: var(--font-size-xs);
    text-transform: uppercase;
    letter-spacing: 0.04em;
    border-bottom-color: var(--color-border);
  }

  .prose :global(tr:hover td) {
    background-color: var(--color-surface-alt);
  }

  .prose :global(blockquote) {
    margin: var(--space-6) 0;
    padding: var(--space-4) var(--space-6);
    border-left: 3px solid var(--color-primary);
    background-color: var(--color-surface);
    border-radius: 0 var(--radius-lg) var(--radius-lg) 0;
    color: var(--color-text);
  }

  .prose :global(blockquote p:last-child) {
    margin-bottom: 0;
  }

  .prose :global(hr) {
    margin: var(--space-10) 0;
    border: none;
    border-top: 1px solid var(--color-border);
  }

  .prose :global(img) {
    max-width: 100%;
    height: auto;
    border-radius: var(--radius-lg);
    margin: var(--space-4) 0;
    border: 1px solid var(--color-border);
  }

  .prose :global(pre) {
    margin: var(--space-4) 0;
    padding: var(--space-4);
    background-color: #F3F4F6;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    overflow-x: auto;
    font-size: var(--font-size-sm);
  }

  .prose :global(code:not(pre code)) {
    padding: 0.1em 0.35em;
    background-color: #F3F4F6;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-size: 0.875em;
    color: var(--color-primary);
  }

  /* MDX component grid layouts */
  .prose :global(.key-findings-grid) {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: var(--space-4);
    margin: var(--space-6) 0;
  }

  .prose :global(.terminology-grid) {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: var(--space-4);
    margin: var(--space-6) 0;
  }

  .prose :global(.implementations-grid) {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: var(--space-6);
    margin: var(--space-6) 0;
  }

  .prose :global(.gap-cards) {
    display: flex;
    flex-direction: column;
    gap: var(--space-6);
    margin: var(--space-6) 0;
  }

  .prose :global(.sdo-cards) {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: var(--space-4);
    margin: var(--space-6) 0;
  }

  .toc-wrapper {
    position: sticky;
    top: calc(var(--header-height) + var(--space-8));
    align-self: start;
  }

  @media (max-width: 1279px) {
    .toc-wrapper {
      display: none;
    }
  }

  @media (max-width: 1024px) {
    .content-layout {
      flex-direction: column;
    }

    .content-main {
      padding: var(--space-6) 0;
    }
  }
</style>
